---
layout: post
title:  "Finding Multiple Security Issues on Agorapulse"
author: snapsec
categories: [Privilege-escalation,XSS,Log4Shell ]
image: assets/images/19/0.png
---





Agorapulse provides everything an organization could possibly need for social media marketing, monitoring, and management. Agorapulse is a full-featured social media management platform. Some of its features include a variety of ways to publish content, scheduling posts and reporting about social account usage. Agorapulse provides a platform for companies for their marketing strategies while also keeping them under the budget radar. The software is used to create and schedule social media content, engage audiences, listen for key terms, and analyse social media performance.


## Approaching the target

The application's functionalities were extensive, and it allowed users to integrate other third-party accounts (complexity). At this stage, we appeared harmless and stealthily explored the app, understanding the *logic of the application* and making ourselves capable of using it. All of this was accomplished with the assistance of their *youtube channels, blogs, support channels, general search queries*, and so on. We investigated the *structure of api paths* and *http requests* for various actions inside the application. We took note of the *ids being used* so that we don't miss out on any **IDOR chances**. The following is a list of a few vulnerabilities we found on agaorapulse.




## 1 - RCE via Log4shell

Log4j has been found to be vulnerable to a number of security threats. The log4j library has recently been found to contain a serious vulnerability.This vulnerability allows unauthenticated remote code execution on vulnerable servers and may be exploited to expose sensitive information.

We were able to discover the vulnerable log4j framework that was implemented by *agorapulse*. We *exploited the same framework* by pasting the *payload in a new post*.

![image](https://user-images.githubusercontent.com/88488902/196965064-21210527-1944-4644-9794-0c679ba73c22.png)


This *resulted in a DNS pingback* from the agora servers. After confirmation, we *exploited the vulnerability* by *reading various environment variables* of agorapulse servers without performing any sensitive *actions*. 


![image](https://user-images.githubusercontent.com/88488902/196965165-a77a7a2c-4c32-44d3-b90c-4e81296cdb1c.png)


You can go through detailed process here [https://snapsec.co/blog/Log4shell-on-agorapulse/](https://snapsec.co/blog/Log4shell-on-agorapulse/).

## Accessing automatic scheduling reports

In agorapulse we can have our reports emailed to us automatically, so that we don't need to worry about exporting them manually again. This feature is available as part of the [Power Reports add-on].
With the guest role in the organisation, a user has limited access to the organisation's social profile settings. The guest user is restricted from viewing the information contained in automatic scheduled reports .
 But we were able to identify a vulnerable endpoint with broken access control that lets an unauthorised role `{ADD ROLE HERE}` to gain access to restricted information `{WHICH INFORMATION}`.

- Scheduled reports information, labels information and the groups information
```http
GET /api/bootstrap?accountId=574034 HTTP/1.1 
```
By forwarding the above request with the authorisation token of a guest user, the response received is 200 ok but it also returns data such as information related to automatic scheduling reports like assigne emails,labels and group names in that particular organisation.


##  Accessing sensitive organisation information

This app had various organisational roles with segregated permissions. One from the list was *guest role* which had no direct access to the *organization* but  few features like *posts to review*,  *likes* etc. We were unable to access various *instinctively vulnerable api paths* using the *credentials of the guest role*.

Until we came across an API endpoint like `GET /api/organizations/[org-id]? organizationId=[org-id] HTTP/1.1`. We premeditated the ids which were being used in the request and quickly identified that this id could return a set of various *information about the organization*, particularly *restricted to the guest role*.  When we sent this request with the credentials/cookies of the guest role, we received a *200 OK* response with various *organization information*. The information included *scheduled calendars, email adresses of shared members, identification ids, meeting dates* and other information.


> Hence, a guest role was able to leak un-authorized information about the organisation.


## Changing ROI settings of account

Return on Investment (ROI) is a popular profitability metric used to evaluate how well an investment has performed. In agorapulse the ROI feature allows you to know the monthly value generated by your page.
With guest permission in an organization, the user has limited access to the organisation's social profile settings. Only users with admin rights can enable or disable the ROI settings for a particular page.

But we were able to identify a broken api endpoint through which a user with guest permission was able to change the ROI settings of a page.

- In the below request, by passing the id parameter of a page, a user with guest permission was able to change the ROI settings of that page without any access to it.

```http
PUT /api/organizations/287159/workspaces/187160/settings/roi/accounts/facebook_574024 HTTP/1.1

{"roiEnabled":true,"postImpressionValue":5,"postLinkClickValue":1,"userEngagedValue":1,"accountUid":"facebook_574024"}
```

> Hence, a guest role was able to change the ROI settings of a page.


## Changing general report settings like logo, timezone etc.

With guest permission in an organization, a user has no access to the general settings of social media profiles. Due to limited permissions, the guest user is not able to change the report settings. 
But we were able to identify a broken api path through which a user with guest permissions was able to change the general report settings of a organisation.The broken access on the vulnerable endpoint lets a guest change the timezone, author name, and logo for the reports.

- Add reporter name and other general report settings
```http
PUT /api/organizations/287157/workspaces/187158/settings/accounts/facebook_574363 HTTP/1.1

{"accountUid":"facebook_574363","authorName":"Waris","browserTimezoneEnabled":true,"locale":"en","timezone":"Asia/Calcutta"}
```

Leveraging this request, we can keep any random author for this organisation and also change the *timezone settings*, which can lead to disruption in automatic postings on accounts.


## Changing rules of inbox assistant from an unauthorized role

This issue was again identified in the *guest role*, which was the lowest level role available in the organization. This role was *granted some basic read permissions* on limited features.

A feature implemented by agora for the automation of inbox messages was *inbox assistant*. Authorized users are able to create custom rules *by which the replies* to the *received messages* will be given. This feature was totally *unaccessible to the guest role* . We discovered a *vulnerable request* while analysing the *flow of the api requests* responsible for *moving the inbox assistants and viewing various rules*. The HTTP request looked something like this:

```http
PUT /api/accounts/twitter_137253/rules HTTP/1.1 
Host: inbox.agorapulse.com 
Connection: close Content-
Length: 17 sec-ch-ua: "Chromium";v="92", " Not A;Brand";v="99", "Google Chrome";v="92" Accept: application/json, text/plain, */ 
Authorization: Bearer


{"from":[inbox-assistant-id-of-current-inbox],"to":[inbox-assistant-id-of-another-inbox]}
```

We received _200 OK_ after sending this request with the credentials of the *guest*, and the rule was moved to *different assistant*. We just need to get the *assistant name* which was leaked to the *guest via another GET request*. Using the name in the mentioned request, we were able to move the rules from this inbox assistant to another inbox assistant.

> Please note the actual http requests were different from the ones posted here.
